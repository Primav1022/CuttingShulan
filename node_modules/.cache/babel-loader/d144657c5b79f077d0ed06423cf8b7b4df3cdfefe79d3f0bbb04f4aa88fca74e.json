{"ast":null,"code":"import React,{useEffect,useRef,useState}from'react';import{fabric}from'fabric';import{jsx as _jsx}from\"react/jsx-runtime\";const FabricCanvas=_ref=>{let{setDataUrl,dataUrl}=_ref;const canvasRef=useRef(null);const fabricCanvasRef=useRef(null);var deleteIcon=\"data:image/svg+xml,%3C%3Fxml version='1.0' encoding='utf-8'%3F%3E%3C!DOCTYPE svg PUBLIC '-//W3C//DTD SVG 1.1//EN' 'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3E%3Csvg version='1.1' id='Ebene_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' width='595.275px' height='595.275px' viewBox='200 215 230 470' xml:space='preserve'%3E%3Ccircle style='fill:%23333333;' cx='299.76' cy='439.067' r='218.516'/%3E%3Cg%3E%3Crect x='267.162' y='307.978' transform='matrix(0.7071 -0.7071 0.7071 0.7071 -222.6202 340.6915)' style='fill:white;' width='65.545' height='262.18'/%3E%3Crect x='266.988' y='308.153' transform='matrix(0.7071 0.7071 -0.7071 0.7071 398.3889 -83.3116)' style='fill:white;' width='65.544' height='262.179'/%3E%3C/g%3E%3C/svg%3E\";var icon=document.createElement('img');icon.src=deleteIcon;const handleDragOver=e=>{e.preventDefault();};const handleDrop=e=>{e.preventDefault();const dragData=e.dataTransfer.getData('application/json');console.log(\"Drag Data:\",dragData);// 检查拖拽数据\nconst{type,url}=JSON.parse(dragData);console.log(\"Type:\",type,\"URL:\",url);// 检查类型和 URL\nif(type==='library'){fabric.Image.fromURL(url,img=>{img.set({selectable:true,scalable:true,hasControls:true});img.scale(0.25);img.setCoords();fabricCanvasRef.current.add(img);saveCanvasState();},{crossOrigin:'anonymous'});}};const saveCanvasState=()=>{const data=JSON.stringify(fabricCanvasRef.current.toDatalessJSON());sessionStorage.setItem('canvasState',data);};const loadCanvasState=()=>{const data=sessionStorage.getItem('canvasState');if(data){fabricCanvasRef.current.loadFromJSON(data,()=>{});}};useEffect(()=>{if(!fabricCanvasRef.current){fabricCanvasRef.current=new fabric.Canvas(canvasRef.current,{width:window.innerHeight*0.6,height:window.innerHeight*0.6,selection:true,preserveObjectStacking:true,interactive:true});fabric.Object.prototype.controls.deleteControl=new fabric.Control({x:0.5,y:-0.5,offsetY:2,cursorStyle:'pointer',mouseUpHandler:deleteObject,render:renderIcon,cornerSize:24});fabric.Object.prototype.borderColor='#F00264';fabric.Object.prototype.cornerStrokeColor=\"#F00264\";fabricCanvasRef.current.requestRenderAll();loadCanvasState();}},[]);function deleteObject(eventData,transform){const target=transform.target;const canvas=target.canvas;canvas.remove(target);canvas.requestRenderAll();}function renderIcon(ctx,left,top,styleOverride,fabricObject){const size=this.cornerSize;ctx.save();ctx.translate(left,top);ctx.rotate(fabric.util.degreesToRadians(fabricObject.angle));ctx.drawImage(icon,-size/2,-size/2,size,size);ctx.restore();}useEffect(()=>{const saveCanvasToDataUrl=()=>{if(fabricCanvasRef.current){const dataURL=fabricCanvasRef.current.toDataURL({format:'png',multiplier:1,quality:1});setDataUrl(dataURL);}};const canvasStateChangeListener=()=>{saveCanvasToDataUrl();saveCanvasState();};const objectModifiedListener=event=>{canvasStateChangeListener();// Update canvas state on object modification\n};if(fabricCanvasRef.current){fabricCanvasRef.current.on('object:added',canvasStateChangeListener);fabricCanvasRef.current.on('object:removed',canvasStateChangeListener);fabricCanvasRef.current.on('object:modified',objectModifiedListener);// Listen for object modification\n}return()=>{if(fabricCanvasRef.current){fabricCanvasRef.current.off('object:added',canvasStateChangeListener);fabricCanvasRef.current.off('object:removed',canvasStateChangeListener);fabricCanvasRef.current.off('object:modified',objectModifiedListener);// Remove event listener\n}};},[setDataUrl]);return/*#__PURE__*/_jsx(\"div\",{onDragOver:handleDragOver,onDrop:handleDrop,style:{border:'3px dashed black',maxWidth:'60vh',maxHeight:'60vh',position:'relative',backgroundColor:'white'},children:/*#__PURE__*/_jsx(\"canvas\",{ref:canvasRef,width:512,height:512,style:{width:'100%',height:'100%'}})});};export default FabricCanvas;","map":{"version":3,"names":["React","useEffect","useRef","useState","fabric","jsx","_jsx","FabricCanvas","_ref","setDataUrl","dataUrl","canvasRef","fabricCanvasRef","deleteIcon","icon","document","createElement","src","handleDragOver","e","preventDefault","handleDrop","dragData","dataTransfer","getData","console","log","type","url","JSON","parse","Image","fromURL","img","set","selectable","scalable","hasControls","scale","setCoords","current","add","saveCanvasState","crossOrigin","data","stringify","toDatalessJSON","sessionStorage","setItem","loadCanvasState","getItem","loadFromJSON","Canvas","width","window","innerHeight","height","selection","preserveObjectStacking","interactive","Object","prototype","controls","deleteControl","Control","x","y","offsetY","cursorStyle","mouseUpHandler","deleteObject","render","renderIcon","cornerSize","borderColor","cornerStrokeColor","requestRenderAll","eventData","transform","target","canvas","remove","ctx","left","top","styleOverride","fabricObject","size","save","translate","rotate","util","degreesToRadians","angle","drawImage","restore","saveCanvasToDataUrl","dataURL","toDataURL","format","multiplier","quality","canvasStateChangeListener","objectModifiedListener","event","on","off","onDragOver","onDrop","style","border","maxWidth","maxHeight","position","backgroundColor","children","ref"],"sources":["F:/同济实习/cutting英文版/cutting/src/components/SketchBox/remake.js"],"sourcesContent":["import React, { useEffect, useRef, useState } from 'react';\r\nimport { fabric } from 'fabric';\r\n\r\nconst FabricCanvas = ({ setDataUrl, dataUrl }) => {\r\n    const canvasRef = useRef(null);\r\n    const fabricCanvasRef = useRef(null);\r\n    var deleteIcon = \"data:image/svg+xml,%3C%3Fxml version='1.0' encoding='utf-8'%3F%3E%3C!DOCTYPE svg PUBLIC '-//W3C//DTD SVG 1.1//EN' 'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3E%3Csvg version='1.1' id='Ebene_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' width='595.275px' height='595.275px' viewBox='200 215 230 470' xml:space='preserve'%3E%3Ccircle style='fill:%23333333;' cx='299.76' cy='439.067' r='218.516'/%3E%3Cg%3E%3Crect x='267.162' y='307.978' transform='matrix(0.7071 -0.7071 0.7071 0.7071 -222.6202 340.6915)' style='fill:white;' width='65.545' height='262.18'/%3E%3Crect x='266.988' y='308.153' transform='matrix(0.7071 0.7071 -0.7071 0.7071 398.3889 -83.3116)' style='fill:white;' width='65.544' height='262.179'/%3E%3C/g%3E%3C/svg%3E\";\r\n\r\n    var icon = document.createElement('img');\r\n    icon.src = deleteIcon;\r\n\r\n    const handleDragOver = (e) => {\r\n        e.preventDefault();\r\n    };\r\n\r\n    const handleDrop = (e) => {\r\n        e.preventDefault();\r\n        const dragData = e.dataTransfer.getData('application/json');\r\n        console.log(\"Drag Data:\", dragData); // 检查拖拽数据\r\n        const { type, url } = JSON.parse(dragData);\r\n        console.log(\"Type:\", type, \"URL:\", url); // 检查类型和 URL\r\n\r\n\r\n\r\n        if (type === 'library') {\r\n            fabric.Image.fromURL(\r\n                url,\r\n                (img) => {\r\n                    img.set({\r\n                        selectable: true,\r\n                        scalable: true,\r\n                        hasControls: true,\r\n                    });\r\n                    img.scale(0.25);\r\n                    img.setCoords();\r\n\r\n\r\n                    fabricCanvasRef.current.add(img);\r\n                    saveCanvasState();\r\n                },\r\n                { crossOrigin: 'anonymous' }\r\n            );\r\n        }\r\n    };\r\n\r\n\r\n    const saveCanvasState = () => {\r\n        const data = JSON.stringify(fabricCanvasRef.current.toDatalessJSON());\r\n        sessionStorage.setItem('canvasState', data);\r\n    };\r\n\r\n    const loadCanvasState = () => {\r\n        const data = sessionStorage.getItem('canvasState');\r\n        if (data) {\r\n            fabricCanvasRef.current.loadFromJSON(data, () => {\r\n\r\n\r\n            });\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        if (!fabricCanvasRef.current) {\r\n            fabricCanvasRef.current = new fabric.Canvas(canvasRef.current, {\r\n                width: window.innerHeight * 0.6,\r\n                height: window.innerHeight * 0.6,\r\n                selection: true,\r\n                preserveObjectStacking: true,\r\n                interactive: true,\r\n            });\r\n\r\n\r\n            fabric.Object.prototype.controls.deleteControl = new fabric.Control({\r\n                x: 0.5,\r\n                y: -0.5,\r\n                offsetY: 2,\r\n                cursorStyle: 'pointer',\r\n                mouseUpHandler: deleteObject,\r\n                render: renderIcon,\r\n                cornerSize: 24\r\n            });\r\n            fabric.Object.prototype.borderColor = '#F00264';\r\n            fabric.Object.prototype.cornerStrokeColor = \"#F00264\";\r\n\r\n\r\n            fabricCanvasRef.current.requestRenderAll();\r\n\r\n            loadCanvasState();\r\n        }\r\n    }, []);\r\n\r\n    function deleteObject(eventData, transform) {\r\n        const target = transform.target;\r\n        const canvas = target.canvas;\r\n        canvas.remove(target);\r\n        canvas.requestRenderAll();\r\n    }\r\n\r\n    function renderIcon(ctx, left, top, styleOverride, fabricObject) {\r\n        const size = this.cornerSize;\r\n        ctx.save();\r\n        ctx.translate(left, top);\r\n        ctx.rotate(fabric.util.degreesToRadians(fabricObject.angle));\r\n        ctx.drawImage(icon, -size / 2, -size / 2, size, size);\r\n        ctx.restore();\r\n    }\r\n\r\n    useEffect(() => {\r\n        const saveCanvasToDataUrl = () => {\r\n            if (fabricCanvasRef.current) {\r\n                const dataURL = fabricCanvasRef.current.toDataURL({\r\n                    format: 'png',\r\n                    multiplier: 1,\r\n                    quality: 1,\r\n                });\r\n                setDataUrl(dataURL);\r\n            }\r\n        };\r\n\r\n        const canvasStateChangeListener = () => {\r\n            saveCanvasToDataUrl();\r\n            saveCanvasState();\r\n        };\r\n\r\n        const objectModifiedListener = (event) => {\r\n            canvasStateChangeListener(); // Update canvas state on object modification\r\n        };\r\n\r\n        if (fabricCanvasRef.current) {\r\n            fabricCanvasRef.current.on('object:added', canvasStateChangeListener);\r\n            fabricCanvasRef.current.on('object:removed', canvasStateChangeListener);\r\n            fabricCanvasRef.current.on('object:modified', objectModifiedListener); // Listen for object modification\r\n        }\r\n\r\n        return () => {\r\n            if (fabricCanvasRef.current) {\r\n                fabricCanvasRef.current.off('object:added', canvasStateChangeListener);\r\n                fabricCanvasRef.current.off('object:removed', canvasStateChangeListener);\r\n                fabricCanvasRef.current.off('object:modified', objectModifiedListener); // Remove event listener\r\n            }\r\n        };\r\n    }, [setDataUrl]);\r\n\r\n\r\n\r\n\r\n    return (\r\n        <div\r\n            onDragOver={handleDragOver}\r\n            onDrop={handleDrop}\r\n            style={{ border: '3px dashed black', maxWidth: '60vh', maxHeight: '60vh', position: 'relative', backgroundColor: 'white' }}\r\n        >\r\n            <canvas\r\n                ref={canvasRef}\r\n                width={512}\r\n                height={512}\r\n                style={{ width: '100%', height: '100%' }}\r\n            ></canvas>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default FabricCanvas;\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}