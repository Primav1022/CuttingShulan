{"ast":null,"code":"import React,{useEffect,useState}from'react';import StepBar from'../../components/StepBar/StepBar';import InputBox from'../../components/InputBox/InputBox';import MaterialLibrary from'../../components/MaterialLibrary/MaterialLibrary';import ShowImg from'../../components/ShowImg/ShowImg';import'./GenerationImg.css';import{useIndexedDBStorage}from'./storage';import LoadingAnimation from\"../../components/loadingicon/loadingicon\";// 确保导入路径正确\nimport{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";const GenerationImg=_ref=>{let{currentStep,handleNextStep,handlePrevStep,selectedMaterials,onAddMaterial}=_ref;const[inputValue,setInputValue]=useState('');const[isUploading,setIsUploading]=useState(false);const[isClicked,setIsClicked]=useState(false);const[showImages,setShowImages]=useSessionStorageState('showImages',false);const[generatedImages,setGeneratedImages]=useIndexedDBStorage('generatedImages',[]);const[variationimg,setvariationimg]=useState(null);function useSessionStorageState(key,defaultValue){const[state,setState]=useState(()=>{const storedValue=sessionStorage.getItem(key);return storedValue!==null?JSON.parse(storedValue):defaultValue;});useEffect(()=>{sessionStorage.setItem(key,JSON.stringify(state));},[key,state]);return[state,setState];}const handleInputChange=e=>{setInputValue(e.target.value);};useEffect(()=>{// 当variationimg变化时，更新value\nconsole.log(variationimg);},[variationimg]);useEffect(()=>{// 当variationimg变化时，更新value\nif(variationimg){const uniquePrefix=Math.random().toString(36).substr(2,5);// 生成一个5个字符的随机字符串\nsetInputValue(\"variationimg: \".concat(uniquePrefix));}},[variationimg]);// 确保依赖项正确\nconst handleUploadWithVariationImg=async()=>{setIsUploading(true);console.log('垫图:',variationimg);try{const response=await fetch('http://202.120.165.127:8004/variation-image',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:inputValue,init_images:variationimg,// 使用variationimg作为垫图数据\nvariationimg:variationimg// 如果需要，也可以将variationimg作为另一个字段发送\n})});if(response.ok){const imagesBase64=await response.json();const imagesUrls=imagesBase64.map(imgBase64=>\"data:image/png;base64,\".concat(imgBase64));setGeneratedImages(prevImages=>[...prevImages,...imagesUrls]);setShowImages(true);}else{console.error('Failed to generate image');}}catch(error){console.error('Error:',error);}setIsUploading(false);setIsClicked(false);// 当按钮被点击时，更新状态为true\n};const handleUploadWithoutVariationImg=async()=>{setIsUploading(true);console.log('Uploading:',inputValue);try{const response=await fetch('http://202.120.165.127:8004/generate-image',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:inputValue})});if(response.ok){const imagesBase64=await response.json();const imagesUrls=imagesBase64.map(imgBase64=>\"data:image/png;base64,\".concat(imgBase64));setGeneratedImages(prevImages=>[...prevImages,...imagesUrls]);setShowImages(true);}else{console.error('Failed to generate image');}}catch(error){console.error('Error:',error);}setIsUploading(false);setIsClicked(false);// 当按钮被点击时，更新状态为true\n};// 根据variationimg的存在与否来选择调用哪个函数\nconst handleUpload=()=>{if(inputValue.startsWith('variationimg')){handleUploadWithVariationImg();}else{handleUploadWithoutVariationImg();}};const handleRegenerateImages=()=>{setIsClicked(true);// 当按钮被点击时，更新状态为true\nhandleUpload();// Reuse the handleUpload function to regenerate images\n};const handleKeyPress=e=>{if(e.key==='Enter'){handleUpload();}};return/*#__PURE__*/_jsxs(\"div\",{className:\"container\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"left-side\",children:[/*#__PURE__*/_jsx(StepBar,{currentStep:currentStep,handleNextStep:handleNextStep,handlePrevStep:handlePrevStep}),/*#__PURE__*/_jsx(\"div\",{className:\"middle\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"bgcolor\",children:[1&&/*#__PURE__*/_jsx(ShowImg,{setvariationimg:setvariationimg,setGeneratedImages:setGeneratedImages,onAddToLibrary:onAddMaterial,images:generatedImages,onRefresh:handleRegenerateImages,showImages:showImages,isClicked:isClicked}),isUploading&&/*#__PURE__*/_jsx(LoadingAnimation,{})]})}),/*#__PURE__*/_jsx(\"div\",{className:\"bottom\",children:/*#__PURE__*/_jsx(InputBox,{variationimg:variationimg,value:inputValue,onChange:handleInputChange,onUpload:handleUpload,onKeyPress:handleKeyPress,isUploading:isUploading})})]}),/*#__PURE__*/_jsx(\"div\",{className:\"right-side\",children:/*#__PURE__*/_jsx(MaterialLibrary,{materials:selectedMaterials})})]});};export default GenerationImg;","map":{"version":3,"names":["React","useEffect","useState","StepBar","InputBox","MaterialLibrary","ShowImg","useIndexedDBStorage","LoadingAnimation","jsx","_jsx","jsxs","_jsxs","GenerationImg","_ref","currentStep","handleNextStep","handlePrevStep","selectedMaterials","onAddMaterial","inputValue","setInputValue","isUploading","setIsUploading","isClicked","setIsClicked","showImages","setShowImages","useSessionStorageState","generatedImages","setGeneratedImages","variationimg","setvariationimg","key","defaultValue","state","setState","storedValue","sessionStorage","getItem","JSON","parse","setItem","stringify","handleInputChange","e","target","value","console","log","uniquePrefix","Math","random","toString","substr","concat","handleUploadWithVariationImg","response","fetch","method","headers","body","prompt","init_images","ok","imagesBase64","json","imagesUrls","map","imgBase64","prevImages","error","handleUploadWithoutVariationImg","handleUpload","startsWith","handleRegenerateImages","handleKeyPress","className","children","onAddToLibrary","images","onRefresh","onChange","onUpload","onKeyPress","materials"],"sources":["F:/同济实习/cutting英文版/cutting/src/containers/GenerationImg/GenerationImg.js"],"sourcesContent":["import React, {useEffect, useState} from 'react';\r\nimport StepBar from '../../components/StepBar/StepBar';\r\nimport InputBox from '../../components/InputBox/InputBox';\r\nimport MaterialLibrary from '../../components/MaterialLibrary/MaterialLibrary';\r\nimport ShowImg from '../../components/ShowImg/ShowImg';\r\nimport './GenerationImg.css';\r\nimport { useIndexedDBStorage } from './storage';\r\nimport LoadingAnimation from \"../../components/loadingicon/loadingicon\";  // 确保导入路径正确\r\n\r\n\r\nconst GenerationImg = ({ currentStep, handleNextStep, handlePrevStep, selectedMaterials, onAddMaterial }) => {\r\n    const [inputValue, setInputValue] = useState('');\r\n    const [isUploading, setIsUploading] = useState(false);\r\n    const [isClicked, setIsClicked] = useState(false);\r\n    const [showImages, setShowImages] = useSessionStorageState('showImages', false);\r\n    const [generatedImages, setGeneratedImages] = useIndexedDBStorage('generatedImages', []);\r\n    const [variationimg,setvariationimg]=useState(null);\r\n    function useSessionStorageState(key, defaultValue) {\r\n        const [state, setState] = useState(() => {\r\n            const storedValue = sessionStorage.getItem(key);\r\n            return storedValue !== null ? JSON.parse(storedValue) : defaultValue;\r\n        });\r\n\r\n        useEffect(() => {\r\n            sessionStorage.setItem(key, JSON.stringify(state));\r\n        }, [key, state]);\r\n        return [state, setState];\r\n    }\r\n    const handleInputChange = (e) => {\r\n        setInputValue(e.target.value);\r\n    };\r\n    useEffect(() => {\r\n        // 当variationimg变化时，更新value\r\n        console.log(variationimg);\r\n    }, [variationimg]);\r\n    useEffect(() => {\r\n        // 当variationimg变化时，更新value\r\n        if (variationimg) {\r\n            const uniquePrefix = Math.random().toString(36).substr(2, 5); // 生成一个5个字符的随机字符串\r\n            setInputValue(`variationimg: ${uniquePrefix}`);\r\n        }\r\n    }, [variationimg]); // 确保依赖项正确\r\n    const handleUploadWithVariationImg = async () => {\r\n        setIsUploading(true);\r\n        console.log('垫图:', variationimg);\r\n\r\n        try {\r\n            const response = await fetch('http://202.120.165.127:8004/variation-image', {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json'\r\n                },\r\n                body: JSON.stringify({\r\n                    prompt: inputValue,\r\n                    init_images: variationimg, // 使用variationimg作为垫图数据\r\n                    variationimg: variationimg // 如果需要，也可以将variationimg作为另一个字段发送\r\n                })\r\n            });\r\n            if (response.ok) {\r\n                const imagesBase64 = await response.json();\r\n                const imagesUrls = imagesBase64.map(imgBase64 => `data:image/png;base64,${imgBase64}`);\r\n                setGeneratedImages(prevImages => [...prevImages, ...imagesUrls]);\r\n                setShowImages(true);\r\n            } else {\r\n                console.error('Failed to generate image');\r\n            }\r\n        } catch (error) {\r\n            console.error('Error:', error);\r\n        }\r\n\r\n        setIsUploading(false);\r\n        setIsClicked(false);  // 当按钮被点击时，更新状态为true\r\n    };\r\n    const handleUploadWithoutVariationImg = async () => {\r\n        setIsUploading(true);\r\n        console.log('Uploading:', inputValue);\r\n\r\n        try {\r\n            const response = await fetch('http://202.120.165.127:8004/generate-image', {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json'\r\n                },\r\n                body: JSON.stringify({ prompt: inputValue })\r\n            });\r\n            if (response.ok) {\r\n                const imagesBase64 = await response.json();\r\n                const imagesUrls = imagesBase64.map(imgBase64 => `data:image/png;base64,${imgBase64}`);\r\n                setGeneratedImages(prevImages => [...prevImages, ...imagesUrls]);\r\n                setShowImages(true);\r\n            } else {\r\n                console.error('Failed to generate image');\r\n            }\r\n        } catch (error) {\r\n            console.error('Error:', error);\r\n        }\r\n\r\n        setIsUploading(false);\r\n        setIsClicked(false);  // 当按钮被点击时，更新状态为true\r\n    };\r\n\r\n// 根据variationimg的存在与否来选择调用哪个函数\r\n    const handleUpload = () => {\r\n        if (inputValue.startsWith('variationimg')) {\r\n            handleUploadWithVariationImg();\r\n        } else {\r\n            handleUploadWithoutVariationImg();\r\n        }\r\n    };\r\n    const handleRegenerateImages = () => {\r\n        setIsClicked(true);  // 当按钮被点击时，更新状态为true\r\n        handleUpload();  // Reuse the handleUpload function to regenerate images\r\n\r\n    };\r\n\r\n    const handleKeyPress = (e) => {\r\n        if (e.key === 'Enter') {\r\n            handleUpload();\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div className=\"container\">\r\n            <div className=\"left-side\">\r\n                <StepBar currentStep={currentStep} handleNextStep={handleNextStep} handlePrevStep={handlePrevStep} />\r\n                <div className=\"middle\">\r\n                    <div className=\"bgcolor\">\r\n                        {/*{showImages && <ShowImg setvariationimg={setvariationimg} setGeneratedImages={setGeneratedImages} onAddToLibrary={onAddMaterial} images={generatedImages} onRefresh={handleRegenerateImages} showImages={showImages} isClicked={isClicked}/>}*/}\r\n                        {1 && <ShowImg setvariationimg={setvariationimg} setGeneratedImages={setGeneratedImages} onAddToLibrary={onAddMaterial} images={generatedImages} onRefresh={handleRegenerateImages} showImages={showImages} isClicked={isClicked}/>}\r\n                        {isUploading && <LoadingAnimation />}\r\n                    </div>\r\n                </div>\r\n                <div className=\"bottom\">\r\n                    <InputBox variationimg={variationimg} value={inputValue} onChange={handleInputChange} onUpload={handleUpload} onKeyPress={handleKeyPress} isUploading={isUploading}  />\r\n                </div>\r\n            </div>\r\n            <div className=\"right-side\">\r\n                <MaterialLibrary materials={selectedMaterials} />\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default GenerationImg;"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}