{"ast":null,"code":"import React,{useState,useEffect}from'react';import StepBar from'../../components/StepBar/StepBar';import MaterialLibrary from'../../components/MaterialLibrary/MaterialLibrary';import SketchBox from'../../components/SketchBox/SketchBox';import'./Makeunit.css';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";const Makeunit=props=>{const{currentStep,handleNextStep,handlePrevStep,selectedMaterials,onAddMaterial,onSaveSketch}=props;const[targets,setTargets]=useState(()=>{const savedTargets=sessionStorage.getItem('sketchTargets');return savedTargets?JSON.parse(savedTargets):[];});useEffect(()=>{sessionStorage.setItem('sketchTargets',JSON.stringify(targets));},[targets]);useEffect(()=>{renderCanvas();},[targets]);// �������а���targets������ÿ��targets����ʱ�����ᴥ����useEffect\nfunction renderCanvas(){const sketchBox=document.querySelector('.sketch-box');if(!sketchBox)return;// ȷ��sketchBox�Ѿ�����Ⱦ\nconst canvas=document.createElement('canvas');const ctx=canvas.getContext('2d');canvas.width=sketchBox.offsetWidth;canvas.height=sketchBox.offsetHeight;// canvas.width = 512;\n// canvas.height = 512;\nconst drawImageOnCanvas=target=>new Promise(resolve=>{const img=new Image();img.src=target.src;img.onload=()=>{ctx.save();ctx.translate(target.x+target.width/2,target.y+target.height/2);ctx.rotate(target.rotate*Math.PI/180);// ����ͼ���Ƿ���ȫ��������\nconst halfWidth=target.width/2;const halfHeight=target.height/2;if(target.x+halfWidth>=0&&target.y+halfHeight>=0&&target.x-halfWidth<=sketchBox.offsetWidth&&target.y-halfHeight<=sketchBox.offsetHeight){ctx.drawImage(img,-halfWidth,-halfHeight,target.width,target.height);}ctx.restore();resolve();};});Promise.all(targets.map(drawImageOnCanvas)).then(()=>{const dataURL=canvas.toDataURL('image/png',1);onSaveSketch(dataURL);// ��dataURL����������������������\n});}return/*#__PURE__*/_jsxs(\"div\",{className:\"container\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"left-side\",children:[/*#__PURE__*/_jsx(StepBar,{currentStep:currentStep,handleNextStep:handleNextStep,handlePrevStep:handlePrevStep,onSavePattern:renderCanvas}),/*#__PURE__*/_jsx(\"div\",{className:\"middle\",children:/*#__PURE__*/_jsx(SketchBox,{targets:targets,setTargets:setTargets})}),/*#__PURE__*/_jsx(\"div\",{className:\"bottom\"})]}),/*#__PURE__*/_jsx(\"div\",{className:\"right-side\",children:/*#__PURE__*/_jsx(MaterialLibrary,{materials:selectedMaterials,onAddMaterial:onAddMaterial})})]});};export default Makeunit;","map":{"version":3,"names":["React","useState","useEffect","StepBar","MaterialLibrary","SketchBox","jsx","_jsx","jsxs","_jsxs","Makeunit","props","currentStep","handleNextStep","handlePrevStep","selectedMaterials","onAddMaterial","onSaveSketch","targets","setTargets","savedTargets","sessionStorage","getItem","JSON","parse","setItem","stringify","renderCanvas","sketchBox","document","querySelector","canvas","createElement","ctx","getContext","width","offsetWidth","height","offsetHeight","drawImageOnCanvas","target","Promise","resolve","img","Image","src","onload","save","translate","x","y","rotate","Math","PI","halfWidth","halfHeight","drawImage","restore","all","map","then","dataURL","toDataURL","className","children","onSavePattern","materials"],"sources":["F:/同济实习/cutting/src/containers/Makeunit/Makeunit.js"],"sourcesContent":["import React, { useState, useEffect } from 'react';\r\nimport StepBar from '../../components/StepBar/StepBar';\r\nimport MaterialLibrary from '../../components/MaterialLibrary/MaterialLibrary';\r\nimport SketchBox from '../../components/SketchBox/SketchBox';\r\nimport './Makeunit.css';\r\n\r\nconst Makeunit = (props) => {\r\n  const { currentStep, handleNextStep, handlePrevStep, selectedMaterials, onAddMaterial, onSaveSketch } = props;\r\n  const [targets, setTargets] = useState(() => {\r\n    const savedTargets = sessionStorage.getItem('sketchTargets');\r\n    return savedTargets ? JSON.parse(savedTargets) : [];\r\n  });\r\n\r\n  useEffect(() => {\r\n    sessionStorage.setItem('sketchTargets', JSON.stringify(targets));\r\n  }, [targets]);\r\n\r\n  useEffect(() => {\r\n    renderCanvas();\r\n  }, [targets]); // �������а���targets������ÿ��targets����ʱ�����ᴥ����useEffect\r\n\r\n  function renderCanvas() {\r\n    const sketchBox = document.querySelector('.sketch-box');\r\n    if (!sketchBox) return; // ȷ��sketchBox�Ѿ�����Ⱦ\r\n\r\n    const canvas = document.createElement('canvas');\r\n    const ctx = canvas.getContext('2d');\r\n\r\n    canvas.width = sketchBox.offsetWidth;\r\n    canvas.height = sketchBox.offsetHeight;\r\n\r\n    // canvas.width = 512;\r\n    // canvas.height = 512;\r\n\r\n    const drawImageOnCanvas = (target) => new Promise((resolve) => {\r\n      const img = new Image();\r\n      img.src = target.src;\r\n      img.onload = () => {\r\n        ctx.save();\r\n        ctx.translate(target.x + target.width / 2, target.y + target.height / 2);\r\n        ctx.rotate(target.rotate * Math.PI / 180);\r\n        // ����ͼ���Ƿ���ȫ��������\r\n        const halfWidth = target.width / 2;\r\n        const halfHeight = target.height / 2;\r\n        if (target.x + halfWidth >= 0 && target.y + halfHeight >= 0 &&\r\n            target.x - halfWidth <= sketchBox.offsetWidth && target.y - halfHeight <= sketchBox.offsetHeight) {\r\n          ctx.drawImage(img, -halfWidth, -halfHeight, target.width, target.height);\r\n        }\r\n        ctx.restore();\r\n        resolve();\r\n      };\r\n    });\r\n\r\n    Promise.all(targets.map(drawImageOnCanvas)).then(() => {\r\n      const dataURL = canvas.toDataURL('image/png', 1);\r\n      onSaveSketch(dataURL); // ��dataURL����������������������\r\n    });\r\n  }\r\n\r\n  return (\r\n      <div className=\"container\">\r\n        <div className=\"left-side\">\r\n          <StepBar currentStep={currentStep} handleNextStep={handleNextStep} handlePrevStep={handlePrevStep} onSavePattern={renderCanvas} />\r\n          <div className=\"middle\">\r\n            <SketchBox targets={targets} setTargets={setTargets} />\r\n          </div>\r\n          <div className=\"bottom\"></div>\r\n        </div>\r\n        <div className=\"right-side\">\r\n          <MaterialLibrary materials={selectedMaterials} onAddMaterial={onAddMaterial} />\r\n        </div>\r\n      </div>\r\n  );\r\n};\r\n\r\nexport default Makeunit;\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}